<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex,nofollow" />
    <title>Admin ‚Äì ·∫¢nh to√†n c·ª•c (globalImgOverrides)</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
    <style>
      /* ·∫®n UI admin m·∫∑c ƒë·ªãnh */
      #adminUI { display:none; }
    </style>
  </head>
  <body>
    <header class="topbar">
      <h1>Admin ·∫£nh t·ª´ v·ª±ng (GLOBAL)</h1>
      <div class="right">
        <button id="btn-login" class="primary">ƒêƒÉng nh·∫≠p</button>
        <button id="btn-logout" class="link" style="display:none">ƒêƒÉng xu·∫•t</button>
      </div>
    </header>

    <!-- M·∫∑c ƒë·ªãnh: hi·ªÉn th·ªã th√¥ng b√°o khi ch∆∞a login ho·∫∑c kh√¥ng c√≥ quy·ªÅn -->
    <div id="noAccess" class="screen auth-screen" style="padding:16px;text-align:center">
      <p><b>B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c kh√¥ng c√≥ quy·ªÅn admin.</b></p>
      <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë√∫ng Gmail ƒë√£ ƒë∆∞·ª£c c·∫•p ph√©p.</p>
    </div>

    <!-- UI qu·∫£n tr·ªã (·∫©n m·∫∑c ƒë·ªãnh) -->
    <main id="adminUI" style="padding:16px;max-width:1000px;margin:0 auto">
      <section class="status" style="grid-template-columns:1fr">
        <div>
          <strong>Ch·ªçn ch·ªß ƒë·ªÅ</strong><br />
          <select id="topicSel"></select>
        </div>
      </section>

      <section style="background:#fff;border:1px solid #f1d7e2;border-radius:12px;padding:12px;margin-top:12px">
        <div style="display:grid;gap:10px">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="searchBox" type="text" placeholder="T√¨m theo t·ª´ ti·∫øng Anh..." style="flex:1;padding:10px;border:1px solid #ddd;border-radius:8px" />
            <button id="btn-refresh" class="secondary">L√†m m·ªõi</button>
          </div>

          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <label class="secondary" style="padding:10px;border-radius:8px;cursor:pointer;border:1px solid #ddd;background:#f6f6f6">
              Ch·ªçn ·∫£nh t·ª´ m√°y
              <input id="fileInput" type="file" accept="image/*" style="display:none" />
            </label>
            <input id="urlInput" type="url" placeholder="Ho·∫∑c d√°n URL ·∫£nh (Imgur,...)" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:8px" />
            <button id="btn-attach" class="primary">L∆∞u ·∫£nh GLOBAL</button>
            <button id="btn-delete" class="danger" title="X√≥a ·∫£nh GLOBAL c·ªßa t·ª´ ƒëang ch·ªçn">X√≥a ·∫£nh GLOBAL</button>
          </div>

          <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
            <div>üü° T·ª´ ƒëang ch·ªçn: <strong id="chosenWord">ch∆∞a</strong></div>
            <div>üîó ·∫¢nh GLOBAL hi·ªán t·∫°i: <a id="currentUrl" href="#" target="_blank">(ch∆∞a c√≥)</a></div>
            <img id="preview" alt="" referrerpolicy="no-referrer"
                 style="max-height:60px;border-radius:8px;display:none;border:1px solid #eee;padding:2px" />
          </div>
        </div>
      </section>

      <section style="margin-top:12px">
        <div id="wordsTable"></div>
      </section>
    </main>

    <!-- Firebase init & datasets -->
    <script src="firebase.js"></script>
    <script src="words_food.js"></script>
    <script src="words_family.js"></script>
    <script src="words_travel.js"></script>
    <script src="words_school.js"></script>
    <script src="words_work.js"></script>
    <script src="words_daily.js"></script>
    <script src="words_dates.js"></script>
    <script src="words_hobbies.js"></script>
    <script src="words_daily_routines.js"></script>

    <script>
      // ====== CONFIG ======
      const ADMIN_EMAILS = [
        "tekido270996@gmail.com",
        "tuyen.ltn.english@gmail.com",
      ];
      const IMGUR_CLIENT_ID = "7bd825b419d3d23"; 

      // ====== Shortcuts ======
      const $ = (s) => document.querySelector(s);
      const adminUI = $("#adminUI");
      const noAccess = $("#noAccess");
      const btnLogin = $("#btn-login");
      const btnLogout = $("#btn-logout");

      const BUILTIN_TOPICS = [
        { id: "food", label: "Food & Drink" },
        { id: "family", label: "Family" },
        { id: "travel", label: "Travel" },
        { id: "school", label: "School" },
        { id: "work", label: "Work" },
        { id: "daily", label: "Daily Life" },
        { id: "dates", label: "Numbers & Dates" },
        { id: "hobbies", label: "Hobbies" },
        { id: "routines", label: "Daily Routines" },
      ];
      function getDataset(topicId) {
        if (topicId === "food") return window.DATA_FOOD || [];
        if (topicId === "family") return window.DATA_FAMILY || [];
        if (topicId === "travel") return window.DATA_TRAVEL || [];
        if (topicId === "school") return window.DATA_SCHOOL || [];
        if (topicId === "work") return window.DATA_WORK || [];
        if (topicId === "daily") return window.DATA_DAILY || [];
        if (topicId === "dates") return window.DATA_DATES || [];
        if (topicId === "hobbies") return window.DATA_HOBBIES || [];
        if (topicId === "routines") return window.DATA_ROUTINES || [];
        return [];
      }

      // ====== Auth gate ======
      function isAdmin(user){
        return !!(user && ADMIN_EMAILS.includes(user.email));
      }
      function openAdminUI(){
        adminUI.style.display = "block";
        noAccess.style.display = "none";
        btnLogin.style.display = "none";
        btnLogout.style.display = "inline-block";
        populateTopics(); renderWords();
      }
      function closeAdminUI(){
        adminUI.style.display = "none";
        noAccess.style.display = "block";
        btnLogin.style.display = "inline-block";
        btnLogout.style.display = "none";
      }

      // ====== UI refs ======
      const topicSel = $("#topicSel");
      const searchBox = $("#searchBox");
      const btnRefresh = $("#btn-refresh");
      const wordsTable = $("#wordsTable");
      const fileInput = $("#fileInput");
      const urlInput = $("#urlInput");
      const btnAttach = $("#btn-attach");
      const btnDelete = $("#btn-delete");
      const chosenWordEl = $("#chosenWord");
      const currentUrlEl = $("#currentUrl");
      const previewEl = $("#preview");

      let CURRENT_TOPIC = "food";
      let CURRENT_WORD = null;

      function populateTopics(){
        topicSel.innerHTML = "";
        BUILTIN_TOPICS.forEach(t=>{
          const opt = document.createElement("option");
          opt.value = t.id; opt.textContent = t.label;
          topicSel.appendChild(opt);
        });
        topicSel.value = CURRENT_TOPIC;
      }

      async function getGlobalUrl(topicId, wordId){
        const docId = `${topicId}__${wordId}`;
        const ref = fb.db.collection("globalImgOverrides").doc(docId);
        const doc = await ref.get();
        return doc.exists ? (doc.data()?.url || "") : "";
      }

      function renderWords(){
        const data = getDataset(CURRENT_TOPIC);
        const q = (searchBox.value||"").trim().toLowerCase();
        const list = q ? data.filter(w=>(w.word||"").toLowerCase().includes(q)) : data;

        const rows = list.map(w=>`
          <tr data-id="${w.id}">
            <td style="white-space:nowrap;padding:8px 10px">${w.word||""}</td>
            <td style="padding:8px 10px">${w.vi||""}</td>
            <td style="padding:8px 10px;width:240px">
              <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
                <button class="pick primary" data-id="${w.id}">Ch·ªçn</button>
                <a class="link" target="_blank" href="${w.img||"#"}">${w.img?"·∫¢nh g·ªëc":"(ch∆∞a c√≥ ·∫£nh g·ªëc)"}</a>
              </div>
            </td>
          </tr>`).join("");

        wordsTable.innerHTML = `
          <div style="overflow:auto;border:1px solid #f1d7e2;border-radius:12px;background:#fff;">
            <table style="width:100%;border-collapse:collapse">
              <thead><tr style="background:#fff4f8">
                <th style="text-align:left;padding:10px">T·ª´</th>
                <th style="text-align:left;padding:10px">Nghƒ©a</th>
                <th style="text-align:left;padding:10px">H√†nh ƒë·ªông</th>
              </tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
          <p style="margin:8px 2px;color:#666">Ch·ªçn m·ªôt t·ª´, r·ªìi Upload/D√°n URL ƒë·ªÉ g·∫Øn ·∫£nh GLOBAL.</p>
        `;
        wordsTable.querySelectorAll(".pick").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-id");
            CURRENT_WORD = data.find(w=>w.id===id) || null;
            chosenWordEl.textContent = CURRENT_WORD ? `${CURRENT_WORD.word} (${CURRENT_WORD.id})` : "ch∆∞a";
            previewEl.style.display = "none";
            const gUrl = CURRENT_WORD ? await getGlobalUrl(CURRENT_TOPIC, CURRENT_WORD.id) : "";
            currentUrlEl.textContent = gUrl?"m·ªü ·∫£nh":"(ch∆∞a c√≥)";
            currentUrlEl.href = gUrl||"#";
          });
        });
      }

      async function uploadToImgur(file){
        if (!file) throw new Error("Ch∆∞a ch·ªçn file ·∫£nh.");
        const form = new FormData(); form.append("image", file);
        const res = await fetch("https://api.imgur.com/3/image", {
          method:"POST", headers:{Authorization:`Client-ID ${IMGUR_CLIENT_ID}`}, body:form
        });
        const json = await res.json();
        if (!json?.success) throw new Error("Upload Imgur th·∫•t b·∫°i.");
        return json.data.link;
      }

      async function saveGlobalOverride(user,topicId,wordId,url){
        if (!isAdmin(user)) throw new Error("B·∫°n kh√¥ng c√≥ quy·ªÅn admin.");
        const docId = `${topicId}__${wordId}`;
        await fb.db.collection("globalImgOverrides").doc(docId).set({
          topicId,wordId,url,
          updatedBy:user.email,
          updatedAt:firebase.firestore.FieldValue.serverTimestamp(),
        },{merge:true});
      }
      async function deleteGlobalOverride(user,topicId,wordId){
        if (!isAdmin(user)) throw new Error("B·∫°n kh√¥ng c√≥ quy·ªÅn admin.");
        const docId = `${topicId}__${wordId}`;
        await fb.db.collection("globalImgOverrides").doc(docId).delete();
      }

      // ====== Events ======
      btnLogin.onclick = async ()=>{ try{ await fb.auth.signInWithPopup(fb.googleProvider);}catch(e){alert("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: "+e.message);} };
      btnLogout.onclick = ()=> fb.auth.signOut();
      topicSel.onchange = ()=>{CURRENT_TOPIC=topicSel.value;CURRENT_WORD=null;chosenWordEl.textContent="ch∆∞a";currentUrlEl.textContent="(ch∆∞a c√≥)";currentUrlEl.href="#";renderWords();};
      btnRefresh.onclick = renderWords;
      searchBox.oninput = renderWords;
      fileInput.onchange = ()=>{const f=fileInput.files?.[0]; if(!f){previewEl.style.display="none";return;} previewEl.src=URL.createObjectURL(f);previewEl.style.display="inline-block";};
      btnAttach.onclick = async ()=>{const user=fb.auth.currentUser; try{if(!CURRENT_WORD) throw new Error("H√£y ch·ªçn m·ªôt t·ª´."); btnAttach.disabled=true;btnAttach.textContent="ƒêang x·ª≠ l√Ω..."; let finalUrl=(urlInput.value||"").trim(); if(!finalUrl){const file=fileInput.files?.[0]; if(!file) throw new Error("Ch·ªçn file ho·∫∑c d√°n URL."); finalUrl=await uploadToImgur(file);} await saveGlobalOverride(user,CURRENT_TOPIC,CURRENT_WORD.id,finalUrl); currentUrlEl.textContent="m·ªü ·∫£nh";currentUrlEl.href=finalUrl; alert("ƒê√£ l∆∞u ·∫£nh GLOBAL.");}catch(e){alert(e.message);}finally{btnAttach.disabled=false;btnAttach.textContent="L∆∞u ·∫£nh GLOBAL";}};
      btnDelete.onclick = async ()=>{const user=fb.auth.currentUser; try{if(!CURRENT_WORD) throw new Error("H√£y ch·ªçn m·ªôt t·ª´."); if(!confirm("X√≥a ·∫£nh GLOBAL?")) return; await deleteGlobalOverride(user,CURRENT_TOPIC,CURRENT_WORD.id); currentUrlEl.textContent="(ch∆∞a c√≥)";currentUrlEl.href="#"; alert("ƒê√£ x√≥a ·∫£nh GLOBAL.");}catch(e){alert(e.message);}};

      // ====== Auth ======
      if(window.fb){ fb.auth.onAuthStateChanged((user)=>{ if(isAdmin(user)) openAdminUI(); else closeAdminUI(); }); }
    </script>
  </body>
</html>
