<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Admin – Ảnh & Chủ đề từ vựng (GLOBAL)</title>
  <link rel="stylesheet" href="styles.css"/>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <style>
    /* Ẩn UI khi chưa qua cổng admin (tránh lộ form) */
    #adminUI{display:none}
    .card{max-width:1100px;margin:0 auto}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row>*{margin:2px 0}
    .field{flex:1;min-width:180px}
    .muted{color:#666}
    .tabbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .tabbar button{padding:8px 12px}
    .table-wrap{overflow:auto;border:1px solid #f1d7e2;border-radius:12px;background:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #f6e7ef;text-align:left}
    thead tr{background:#fff4f8}
  </style>
</head>
<body>
<header class="topbar">
  <h1>Admin từ vựng (GLOBAL)</h1>
  <div class="right">
    <button id="btn-login" class="primary">Đăng nhập</button>
    <button id="btn-logout" class="link" style="display:none">Đăng xuất</button>
  </div>
</header>

<!-- Màn hình khi chưa có quyền -->
<div id="noAccess" class="screen auth-screen" style="padding:16px;text-align:center">
  <p><b>Bạn chưa đăng nhập hoặc không có quyền admin.</b></p>
  <p class="muted">Đăng nhập đúng Gmail đã được cấp phép để tiếp tục.</p>
</div>

<!-- UI chính -->
<main id="adminUI" style="padding:16px;max-width:1150px;margin:0 auto">
  <!-- Tabs -->
  <div class="tabbar">
    <button id="tab-images" class="primary">1) Ảnh GLOBAL</button>
    <button id="tab-topics" class="secondary">2) Quản lý chủ đề & từ (cloud)</button>
  </div>

  <!-- ========== TAB 1: ẢNH GLOBAL ========== -->
  <section id="panel-images" class="card">
    <section class="status" style="grid-template-columns:1fr">
      <div>
        <strong>Chọn chủ đề</strong><br/>
        <select id="topicSel_img"></select>
      </div>
    </section>

    <section style="background:#fff;border:1px solid #f1d7e2;border-radius:12px;padding:12px;margin-top:12px">
      <div style="display:grid;gap:10px">
        <div class="row">
          <input id="searchBox_img" class="field" type="text" placeholder="Tìm theo từ tiếng Anh..." style="padding:10px;border:1px solid #ddd;border-radius:8px"/>
          <button id="btn-refresh_img" class="secondary">Làm mới</button>
        </div>

        <div class="row">
          <label class="secondary" style="padding:10px;border-radius:8px;cursor:pointer;border:1px solid #ddd;background:#f6f6f6">
            Chọn ảnh từ máy
            <input id="fileInput" type="file" accept="image/*" style="display:none"/>
          </label>
          <input id="urlInput" class="field" type="url" placeholder="Hoặc dán URL ảnh (Imgur,...)" style="padding:10px;border:1px solid #ddd;border-radius:8px"/>
          <button id="btn-attach" class="primary">Lưu ảnh GLOBAL</button>
          <button id="btn-delete" class="danger" title="Xóa ảnh GLOBAL của từ đang chọn">Xóa ảnh GLOBAL</button>
        </div>

        <div class="row" style="gap:16px">
          <div>🟡 Từ đang chọn: <strong id="chosenWord">chưa</strong></div>
          <div>🔗 Ảnh GLOBAL hiện tại: <a id="currentUrl" href="#" target="_blank">(chưa có)</a></div>
          <img id="preview" alt="" referrerpolicy="no-referrer" style="max-height:60px;border-radius:8px;display:none;border:1px solid #eee;padding:2px"/>
        </div>
      </div>
    </section>

    <section style="margin-top:12px">
      <div id="wordsTable_img"></div>
    </section>
  </section>

  <!-- ========== TAB 2: CHỦ ĐỀ & TỪ (CLOUD) ========== -->
  <section id="panel-topics" class="card" style="display:none">
    <!-- Tạo/chỉnh sửa chủ đề -->
    <div style="background:#fff;border:1px solid #f1d7e2;border-radius:12px;padding:12px">
      <h3>Chủ đề (cloud)</h3>
      <div class="row">
        <input id="topicLabel" class="field" type="text" placeholder="Tên chủ đề (vd: Hobbies 2)" style="padding:10px;border:1px solid #ddd;border-radius:8px"/>
        <input id="topicIcon" class="field" type="text" placeholder="Emoji (tuỳ chọn) 📚" style="padding:10px;border:1px solid #ddd;border-radius:8px"/>
        <input id="topicId" class="field" type="text" placeholder="ID (để trống sẽ auto dạng g_slug)" style="padding:10px;border:1px solid #ddd;border-radius:8px"/>
        <button id="btn-create-topic" class="primary">Tạo/chỉnh sửa</button>
        <button id="btn-delete-topic" class="danger">Xóa chủ đề</button>
      </div>
      <p class="muted" style="margin:4px 0">
        Chủ đề cloud nằm trong collection <code>globalTopics</code>. ID nên là chữ thường, gạch nối (vd: <code>g_hobbies</code>). Nếu để trống, hệ thống sẽ tự sinh <code>g_&lt;slug&gt;</code>.
      </p>
      <div style="margin-top:8px">
        <label><b>Đang chọn:</b></label>
        <select id="topicSel_cloud"></select>
        <button id="btn-reload-topics" class="secondary">Tải danh sách</button>
      </div>
    </div>

    <!-- Thêm/sửa từ -->
    <div style="background:#fff;border:1px solid #f1d7e2;border-radius:12px;padding:12px;margin-top:12px">
      <h3>Thêm / Sửa từ trong chủ đề cloud</h3>
      <div class="row">
        <input id="w_word"  class="field" type="text" placeholder="Tiếng Anh (bắt buộc)"     style="padding:10px;border:1px solid #ddd;border-radius:8px"/>
        <input id="w_vi"    class="field" type="text" placeholder="Nghĩa tiếng Việt (bắt buộc)" style="padding:10px;border:1px solid #ddd;border-radius:8px"/>
        <input id="w_ipa"   class="field" type="text" placeholder="IPA /ˈæp.əl/"           style="padding:10px;border:1px solid #ddd;border-radius:8px"/>
        <input id="w_pos"   class="field" type="text" placeholder="pos (noun/verb/...)"    style="padding:10px;border:1px solid #ddd;border-radius:8px"/>
      </div>
      <div class="row">
        <input id="w_exEn"  class="field" type="text" placeholder="Ví dụ EN" style="padding:10px;border:1px solid #ddd;border-radius:8px"/>
        <input id="w_exVi"  class="field" type="text" placeholder="Ví dụ VI" style="padding:10px;border:1px solid #ddd;border-radius:8px"/>
        <input id="w_img"   class="field" type="url"  placeholder="Ảnh (URL/Imgur)" style="padding:10px;border:1px solid #ddd;border-radius:8px"/>
        <input id="w_id"    class="field" type="text" placeholder="Word ID (để trống tự sinh)" style="padding:10px;border:1px solid #ddd;border-radius:8px"/>
      </div>
      <div class="row">
        <label class="secondary" style="padding:10px;border-radius:8px;cursor:pointer;border:1px solid #ddd;background:#f6f6f6">
          Ảnh từ máy (upload Imgur)
          <input id="w_file" type="file" accept="image/*" style="display:none"/>
        </label>
        <img id="w_preview" style="max-height:60px;border:1px solid #eee;border-radius:8px;display:none" alt="" referrerpolicy="no-referrer"/>
        <button id="btn-save-word" class="primary">Lưu từ</button>
        <button id="btn-delete-word" class="danger">Xóa từ</button>
        <button id="btn-clear-form" class="secondary">Làm mới form</button>
      </div>
      <p class="muted" style="margin:4px 0">Các từ cloud nằm ở collection <code>globalWords</code> (docId: <code>${topicId}__${wordId}</code>).</p>
    </div>

    <!-- Danh sách từ trong chủ đề cloud -->
    <div style="margin-top:12px">
      <div id="wordsTable_cloud"></div>
    </div>
  </section>
</main>

<!-- datasets sẵn có (Tab 1 dùng để liệt kê từ) -->
<script src="firebase.js"></script>
<script src="words_food.js?v=1"></script>
<script src="words_family.js?v=1"></script>
<script src="words_travel.js?v=1"></script>
<script src="words_school.js?v=1"></script>
<script src="words_work.js?v=1"></script>
<script src="words_daily.js?v=1"></script>
<script src="words_dates.js?v=1"></script>
<script src="words_hobbies.js?v=1"></script>
<script src="words_daily_routines.js?v=1"></script>

<script>
/* ================== CONFIG ================== */
const ADMIN_EMAILS = [
  "tekido270996@gmail.com",
  "tuyen.ltn.english@gmail.com",
];
// Imgur
const IMGUR_CLIENT_ID = "7bd825b419d3d23";

/* ================== SHORTCUTS ================== */
const $ = s => document.querySelector(s);
const adminUI = $("#adminUI");
const noAccess = $("#noAccess");
const btnLogin = $("#btn-login");
const btnLogout = $("#btn-logout");

// Tabs
const tabImages = $("#tab-images");
const tabTopics = $("#tab-topics");
const panelImages = $("#panel-images");
const panelTopics = $("#panel-topics");

const isAdmin = (user) => !!(user && ADMIN_EMAILS.includes(user.email));
function openAdminUI(){ adminUI.style.display="block"; noAccess.style.display="none"; btnLogin.style.display="none"; btnLogout.style.display="inline-block"; }
function closeAdminUI(){ adminUI.style.display="none"; noAccess.style.display="block"; btnLogin.style.display="inline-block"; btnLogout.style.display="none"; }

/* ================== TAB SWITCH ================== */
tabImages.onclick = ()=>{ tabImages.className="primary"; tabTopics.className="secondary"; panelImages.style.display="block"; panelTopics.style.display="none"; };
tabTopics.onclick = ()=>{ tabTopics.className="primary"; tabImages.className="secondary"; panelTopics.style.display="block"; panelImages.style.display="none"; };

/* ================== TAB 1: ẢNH GLOBAL ================== */
const BUILTIN_TOPICS = [
  { id: "food", label: "Food & Drink" },
  { id: "family", label: "Family" },
  { id: "travel", label: "Travel" },
  { id: "school", label: "School" },
  { id: "work", label: "Work" },
  { id: "daily", label: "Daily Life" },
  { id: "dates", label: "Numbers & Dates" },
  { id: "hobbies", label: "Hobbies" },
  { id: "routines", label: "Daily Routines" },
];
function getDataset(topicId){
  if (topicId==="food") return window.DATA_FOOD||[];
  if (topicId==="family") return window.DATA_FAMILY||[];
  if (topicId==="travel") return window.DATA_TRAVEL||[];
  if (topicId==="school") return window.DATA_SCHOOL||[];
  if (topicId==="work") return window.DATA_WORK||[];
  if (topicId==="daily") return window.DATA_DAILY||[];
  if (topicId==="dates") return window.DATA_DATES||[];
  if (topicId==="hobbies") return window.DATA_HOBBIES||[];
  if (topicId==="routines") return window.DATA_ROUTINES||[];
  return [];
}
const topicSel_img = $("#topicSel_img");
const searchBox_img = $("#searchBox_img");
const btnRefresh_img = $("#btn-refresh_img");
const wordsTable_img = $("#wordsTable_img");
const fileInput = $("#fileInput");
const urlInput = $("#urlInput");
const btnAttach = $("#btn-attach");
const btnDelete = $("#btn-delete");
const chosenWordEl = $("#chosenWord");
const currentUrlEl = $("#currentUrl");
const previewEl = $("#preview");

let CURRENT_TOPIC_IMG = "food";
let CURRENT_WORD_IMG = null;

function populateTopics_img(){
  topicSel_img.innerHTML = "";
  BUILTIN_TOPICS.forEach(t=>{
    const opt = document.createElement("option");
    opt.value = t.id; opt.textContent = t.label;
    topicSel_img.appendChild(opt);
  });
  topicSel_img.value = CURRENT_TOPIC_IMG;
}
async function getGlobalUrl(topicId, wordId){
  const ref = fb.db.collection("globalImgOverrides").doc(`${topicId}__${wordId}`);
  const doc = await ref.get();
  return doc.exists ? (doc.data()?.url || "") : "";
}
function renderWords_img(){
  const data = getDataset(CURRENT_TOPIC_IMG);
  const q = (searchBox_img.value||"").trim().toLowerCase();
  const list = q ? data.filter(w=>(w.word||"").toLowerCase().includes(q)) : data;
  const rows = list.map(w=>`
    <tr data-id="${w.id}">
      <td>${w.word||""}</td>
      <td>${w.vi||""}</td>
      <td style="width:260px">
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <button class="pick primary" data-id="${w.id}">Chọn</button>
          <a class="link" target="_blank" href="${w.img||"#"}">${w.img?"Ảnh gốc":"(chưa có ảnh gốc)"}</a>
        </div>
      </td>
    </tr>
  `).join("");
  wordsTable_img.innerHTML = `
    <div class="table-wrap">
      <table>
        <thead><tr><th>Từ</th><th>Nghĩa</th><th>Hành động</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
  wordsTable_img.querySelectorAll(".pick").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute("data-id");
      const w = (getDataset(CURRENT_TOPIC_IMG)||[]).find(x=>x.id===id) || null;
      CURRENT_WORD_IMG = w;
      chosenWordEl.textContent = w ? `${w.word} (${w.id})` : "chưa";
      previewEl.style.display = "none";
      const gUrl = w ? await getGlobalUrl(CURRENT_TOPIC_IMG, w.id) : "";
      currentUrlEl.textContent = gUrl ? "mở ảnh" : "(chưa có)";
      currentUrlEl.href = gUrl || "#";
    };
  });
}
async function uploadToImgur(file){
  if (!file) throw new Error("Chưa chọn file ảnh.");
  if (!IMGUR_CLIENT_ID) throw new Error("Chưa cấu hình IMGUR_CLIENT_ID.");
  const form = new FormData();
  form.append("image", file);
  const res = await fetch("https://api.imgur.com/3/image", {
    method:"POST",
    headers:{ Authorization:`Client-ID ${IMGUR_CLIENT_ID}` },
    body: form
  });
  const json = await res.json();
  if (!json?.success) throw new Error("Upload Imgur thất bại.");
  return json.data.link;
}
async function saveGlobalOverride(user, topicId, wordId, url){
  if (!isAdmin(user)) throw new Error("Bạn không có quyền admin.");
  await fb.db.collection("globalImgOverrides").doc(`${topicId}__${wordId}`).set({
    topicId, wordId, url,
    updatedBy: user.email,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
  }, {merge:true});
}
async function deleteGlobalOverride(user, topicId, wordId){
  if (!isAdmin(user)) throw new Error("Bạn không có quyền admin.");
  await fb.db.collection("globalImgOverrides").doc(`${topicId}__${wordId}`).delete();
}
topicSel_img.onchange = ()=>{ CURRENT_TOPIC_IMG = topicSel_img.value; CURRENT_WORD_IMG=null; chosenWordEl.textContent="chưa"; currentUrlEl.textContent="(chưa có)"; currentUrlEl.href="#"; renderWords_img(); };
btnRefresh_img.onclick = renderWords_img;
searchBox_img.oninput = renderWords_img;
fileInput.onchange = ()=>{ const f=fileInput.files?.[0]; if(!f){previewEl.style.display="none";return;} previewEl.src=URL.createObjectURL(f); previewEl.style.display="inline-block"; };
btnAttach.onclick = async ()=>{
  const user = fb.auth.currentUser;
  try{
    if (!isAdmin(user)) throw new Error("Bạn không có quyền admin.");
    if (!CURRENT_WORD_IMG) throw new Error("Hãy chọn một từ trước.");
    btnAttach.disabled=true; btnAttach.textContent="Đang xử lý...";
    let finalUrl = (urlInput.value||"").trim();
    if (!finalUrl){
      const f = fileInput.files?.[0];
      if (!f) throw new Error("Chọn file hoặc dán URL ảnh.");
      finalUrl = await uploadToImgur(f);
    }
    await saveGlobalOverride(user, CURRENT_TOPIC_IMG, CURRENT_WORD_IMG.id, finalUrl);
    currentUrlEl.textContent="mở ảnh"; currentUrlEl.href=finalUrl;
    alert("Đã lưu ảnh GLOBAL.");
  }catch(e){ alert(e.message||"Lỗi không xác định"); }
  finally{ btnAttach.disabled=false; btnAttach.textContent="Lưu ảnh GLOBAL"; }
};
btnDelete.onclick = async ()=>{
  const user = fb.auth.currentUser;
  try{
    if (!isAdmin(user)) throw new Error("Bạn không có quyền admin.");
    if (!CURRENT_WORD_IMG) throw new Error("Hãy chọn một từ trước.");
    if (!confirm("Xóa ảnh GLOBAL của từ này?")) return;
    await deleteGlobalOverride(user, CURRENT_TOPIC_IMG, CURRENT_WORD_IMG.id);
    currentUrlEl.textContent="(chưa có)"; currentUrlEl.href="#";
    alert("Đã xóa ảnh GLOBAL.");
  }catch(e){ alert(e.message||"Lỗi không xác định"); }
};

/* ================== TAB 2: CLOUD TOPICS & WORDS ================== */
const topicLabel = $("#topicLabel");
const topicIcon  = $("#topicIcon");
const topicIdInp = $("#topicId");
const btnCreateTopic = $("#btn-create-topic");
const btnDeleteTopic = $("#btn-delete-topic");
const topicSel_cloud = $("#topicSel_cloud");
const btnReloadTopics = $("#btn-reload-topics");

const w_word = $("#w_word");
const w_vi   = $("#w_vi");
const w_ipa  = $("#w_ipa");
const w_pos  = $("#w_pos");
const w_exEn = $("#w_exEn");
const w_exVi = $("#w_exVi");
const w_img  = $("#w_img");
const w_id   = $("#w_id");
const w_file = $("#w_file");
const w_preview = $("#w_preview");
const btnSaveWord = $("#btn-save-word");
const btnDeleteWord = $("#btn-delete-word");
const btnClearForm = $("#btn-clear-form");
const wordsTable_cloud = $("#wordsTable_cloud");

let CURRENT_TOPIC_CLOUD = "";
let SELECTED_WORD_ID = "";

function slugify(s){ return (s||"").toLowerCase().trim().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""); }

async function loadCloudTopics(){
  const snap = await fb.db.collection("globalTopics").orderBy("label").get();
  topicSel_cloud.innerHTML = "";
  snap.forEach(doc=>{
    const t = doc.data();
    const opt = document.createElement("option");
    opt.value = t.id;
    opt.textContent = `${t.icon||""} ${t.label} (${t.id})`;
    topicSel_cloud.appendChild(opt);
  });
  CURRENT_TOPIC_CLOUD = snap.empty ? "" : topicSel_cloud.value;
}

async function createOrUpdateTopic(user){
  if (!isAdmin(user)) throw new Error("Bạn không có quyền admin.");
  const label = (topicLabel.value||"").trim();
  if (!label) throw new Error("Nhập tên chủ đề.");
  let id = (topicIdInp.value||"").trim();
  if (!id) id = "g_" + slugify(label);
  const icon = (topicIcon.value||"").trim();
  await fb.db.collection("globalTopics").doc(id).set({
    id, label, icon,
    createdBy: user.email,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
  }, {merge:true});
  alert("Đã tạo/cập nhật chủ đề.");
  await loadCloudTopics();
  topicSel_cloud.value = id;
  CURRENT_TOPIC_CLOUD = id;
  await renderWords_cloud();
}

async function deleteTopic(user){
  if (!isAdmin(user)) throw new Error("Bạn không có quyền admin.");
  if (!CURRENT_TOPIC_CLOUD) throw new Error("Chưa chọn chủ đề cloud.");
  if (!confirm("Xóa chủ đề này và toàn bộ từ thuộc nó?")) return;
  // Xóa các từ trước
  const qs = await fb.db.collection("globalWords").where("topicId","==",CURRENT_TOPIC_CLOUD).get();
  const batch = fb.db.batch();
  qs.forEach(d=>batch.delete(d.ref));
  await batch.commit();
  // Xóa topic
  await fb.db.collection("globalTopics").doc(CURRENT_TOPIC_CLOUD).delete();
  alert("Đã xóa chủ đề.");
  await loadCloudTopics();
  wordsTable_cloud.innerHTML = "";
}

/* === KHÔNG CẦN INDEX: lấy về rồi sort ở client === */
async function renderWords_cloud(){
  if (!CURRENT_TOPIC_CLOUD){
    wordsTable_cloud.innerHTML = "<p class='muted'>Chưa có chủ đề cloud.</p>";
    return;
  }
  const qs = await fb.db.collection("globalWords")
    .where("topicId","==",CURRENT_TOPIC_CLOUD)
    .get();

  const items = qs.docs.map(d => d.data())
    .sort((a,b)=>(a.word||"").localeCompare(b.word||"", "en", {sensitivity:"base"}));

  const rows = items.map(w => `
    <tr data-id="${w.wordId}">
      <td>${w.word||""}</td>
      <td>${w.vi||""}</td>
      <td>${w.pos||""}</td>
      <td style="width:260px">
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <button class="pickCloud primary" data-id="${w.wordId}">Chọn</button>
          <a class="link" target="_blank" href="${w.img||"#"}">${w.img?"Ảnh":"(no img)"}</a>
        </div>
      </td>
    </tr>
  `).join("");

  wordsTable_cloud.innerHTML = `
    <div class="table-wrap">
      <table>
        <thead><tr><th>Từ</th><th>Nghĩa</th><th>POS</th><th>Hành động</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;

  wordsTable_cloud.querySelectorAll(".pickCloud").forEach(btn=>{
    btn.onclick = ()=> loadWordToForm(btn.getAttribute("data-id"));
  });
}

async function loadWordToForm(wordId){
  const doc = await fb.db.collection("globalWords").doc(`${CURRENT_TOPIC_CLOUD}__${wordId}`).get();
  if (!doc.exists) return;
  const w = doc.data();
  SELECTED_WORD_ID = w.wordId;
  w_word.value = w.word||"";
  w_vi.value   = w.vi||"";
  w_ipa.value  = w.ipa||"";
  w_pos.value  = w.pos||"";
  w_exEn.value = w.exEn||"";
  w_exVi.value = w.exVi||"";
  w_img.value  = w.img||"";
  w_id.value   = w.wordId||"";
  if (w.img){ w_preview.src = w.img; w_preview.style.display="inline-block"; }
  else w_preview.style.display="none";
}

function clearWordForm(){
  SELECTED_WORD_ID = "";
  [w_word,w_vi,w_ipa,w_pos,w_exEn,w_exVi,w_img,w_id].forEach(i=>i.value="");
  if (w_file) w_file.value = "";
  w_preview.style.display="none";
}
w_file.onchange = ()=>{
  const f = w_file.files?.[0];
  if (!f){ w_preview.style.display="none"; return; }
  w_preview.src = URL.createObjectURL(f);
  w_preview.style.display = "inline-block";
};

async function saveWord(user){
  if (!isAdmin(user)) throw new Error("Bạn không có quyền admin.");
  if (!CURRENT_TOPIC_CLOUD) throw new Error("Chưa chọn chủ đề cloud.");
  const word = (w_word.value||"").trim();
  const vi   = (w_vi.value||"").trim();
  if (!word || !vi) throw new Error("Cần nhập Tiếng Anh và Nghĩa.");

  // upload ảnh nếu có file
  let img = (w_img.value||"").trim();
  if (!img && w_file.files?.[0]){
    img = await uploadToImgur(w_file.files[0]);
    w_img.value = img;
  }

  let wordId = (w_id.value||"").trim();
  if (!wordId) wordId = slugify(word) || String(Date.now());

  const docId = `${CURRENT_TOPIC_CLOUD}__${wordId}`;
  await fb.db.collection("globalWords").doc(docId).set({
    topicId: CURRENT_TOPIC_CLOUD,
    wordId, word, vi,
    ipa: w_ipa.value||"",
    pos: w_pos.value||"",
    exEn: w_exEn.value||"",
    exVi: w_exVi.value||"",
    img: img||"",
    updatedBy: user.email,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
  }, {merge:true});

  alert("Đã lưu từ.");
  SELECTED_WORD_ID = wordId;
  await renderWords_cloud();
}

async function deleteWord(user){
  if (!isAdmin(user)) throw new Error("Bạn không có quyền admin.");
  const wordId = (w_id.value||SELECTED_WORD_ID||"").trim();
  if (!CURRENT_TOPIC_CLOUD || !wordId) throw new Error("Chưa chọn từ.");
  if (!confirm("Xóa từ này?")) return;
  await fb.db.collection("globalWords").doc(`${CURRENT_TOPIC_CLOUD}__${wordId}`).delete();
  alert("Đã xóa.");
  clearWordForm();
  await renderWords_cloud();
}

/* events tab 2 */
btnCreateTopic.onclick  = ()=> createOrUpdateTopic(fb.auth.currentUser).catch(e=>alert(e.message||"Lỗi"));
btnDeleteTopic.onclick  = ()=> deleteTopic(fb.auth.currentUser).catch(e=>alert(e.message||"Lỗi"));
btnReloadTopics.onclick = async ()=>{ await loadCloudTopics(); await renderWords_cloud(); };
topicSel_cloud.onchange = async ()=>{ CURRENT_TOPIC_CLOUD = topicSel_cloud.value; await renderWords_cloud(); };
btnSaveWord.onclick     = ()=> saveWord(fb.auth.currentUser).catch(e=>alert(e.message||"Lỗi"));
btnDeleteWord.onclick   = ()=> deleteWord(fb.auth.currentUser).catch(e=>alert(e.message||"Lỗi"));
btnClearForm.onclick    = clearWordForm;

/* ================== AUTH ================== */
btnLogin.onclick  = async()=>{ try{ await fb.auth.signInWithPopup(fb.googleProvider); }catch(e){ alert("Đăng nhập thất bại: "+e.message); } };
btnLogout.onclick = ()=> fb.auth.signOut();

if (window.fb){
  fb.auth.onAuthStateChanged(async (user)=>{
    if (isAdmin(user)){
      openAdminUI();
      // Tab 1 (Ảnh)
      populateTopics_img();
      renderWords_img();
      // Tab 2 (Chủ đề & từ)
      await loadCloudTopics();
      await renderWords_cloud();
    }else{
      closeAdminUI();
    }
  });
}
</script>
</body>
</html>
