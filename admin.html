<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex,nofollow" />
    <title>Admin â€“ áº¢nh toÃ n cá»¥c (globalImgOverrides)</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
    <style>
      /* áº¨n UI admin máº·c Ä‘á»‹nh */
      #adminUI { display:none; }
    </style>
  </head>
  <body>
    <header class="topbar">
      <h1>Admin áº£nh tá»« vá»±ng (GLOBAL)</h1>
      <div class="right">
        <button id="btn-login" class="primary">ÄÄƒng nháº­p</button>
        <button id="btn-logout" class="link" style="display:none">ÄÄƒng xuáº¥t</button>
      </div>
    </header>

    <!-- Máº·c Ä‘á»‹nh: hiá»ƒn thá»‹ thÃ´ng bÃ¡o khi chÆ°a login hoáº·c khÃ´ng cÃ³ quyá»n -->
    <div id="noAccess" class="screen auth-screen" style="padding:16px;text-align:center">
      <p><b>Báº¡n chÆ°a Ä‘Äƒng nháº­p hoáº·c khÃ´ng cÃ³ quyá»n admin.</b></p>
      <p>Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘Ãºng Gmail Ä‘Ã£ Ä‘Æ°á»£c cáº¥p phÃ©p.</p>
    </div>

    <!-- UI quáº£n trá»‹ (áº©n máº·c Ä‘á»‹nh) -->
    <main id="adminUI" style="padding:16px;max-width:1000px;margin:0 auto">
      <section class="status" style="grid-template-columns:1fr">
        <div>
          <strong>Chá»n chá»§ Ä‘á»</strong><br />
          <select id="topicSel"></select>
        </div>
      </section>

      <section style="background:#fff;border:1px solid #f1d7e2;border-radius:12px;padding:12px;margin-top:12px">
        <div style="display:grid;gap:10px">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="searchBox" type="text" placeholder="TÃ¬m theo tá»« tiáº¿ng Anh..." style="flex:1;padding:10px;border:1px solid #ddd;border-radius:8px" />
            <button id="btn-refresh" class="secondary">LÃ m má»›i</button>
          </div>

          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <label class="secondary" style="padding:10px;border-radius:8px;cursor:pointer;border:1px solid #ddd;background:#f6f6f6">
              Chá»n áº£nh tá»« mÃ¡y
              <input id="fileInput" type="file" accept="image/*" style="display:none" />
            </label>
            <input id="urlInput" type="url" placeholder="Hoáº·c dÃ¡n URL áº£nh (Imgur,...)" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:8px" />
            <button id="btn-attach" class="primary">LÆ°u áº£nh GLOBAL</button>
            <button id="btn-delete" class="danger" title="XÃ³a áº£nh GLOBAL cá»§a tá»« Ä‘ang chá»n">XÃ³a áº£nh GLOBAL</button>
          </div>

          <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
            <div>ğŸŸ¡ Tá»« Ä‘ang chá»n: <strong id="chosenWord">chÆ°a</strong></div>
            <div>ğŸ”— áº¢nh GLOBAL hiá»‡n táº¡i: <a id="currentUrl" href="#" target="_blank">(chÆ°a cÃ³)</a></div>
            <img id="preview" alt="" referrerpolicy="no-referrer"
                 style="max-height:60px;border-radius:8px;display:none;border:1px solid #eee;padding:2px" />
          </div>
        </div>
      </section>

      <section style="margin-top:12px">
        <div id="wordsTable"></div>
      </section>
    </main>

    <!-- Firebase init & datasets -->
    <script src="firebase.js"></script>
    <script src="words_food.js"></script>
    <script src="words_family.js"></script>
    <script src="words_travel.js"></script>
    <script src="words_school.js"></script>
    <script src="words_work.js"></script>
    <script src="words_daily.js"></script>
    <script src="words_dates.js"></script>
    <script src="words_hobbies.js"></script>
    <script src="words_daily_routines.js"></script>

    <script>
      // ====== CONFIG ======
      const ADMIN_EMAILS = [
        "tekido270996@gmail.com",
        "tuyen.ltn.english@gmail.com",
      ];
      const IMGUR_CLIENT_ID = "7bd825b419d3d23"; 

      // ====== Shortcuts ======
      const $ = (s) => document.querySelector(s);
      const adminUI = $("#adminUI");
      const noAccess = $("#noAccess");
      const btnLogin = $("#btn-login");
      const btnLogout = $("#btn-logout");

      const BUILTIN_TOPICS = [
        { id: "food", label: "Food & Drink" },
        { id: "family", label: "Family" },
        { id: "travel", label: "Travel" },
        { id: "school", label: "School" },
        { id: "work", label: "Work" },
        { id: "daily", label: "Daily Life" },
        { id: "dates", label: "Numbers & Dates" },
        { id: "hobbies", label: "Hobbies" },
        { id: "routines", label: "Daily Routines" },
      ];
      function getDataset(topicId) {
        if (topicId === "food") return window.DATA_FOOD || [];
        if (topicId === "family") return window.DATA_FAMILY || [];
        if (topicId === "travel") return window.DATA_TRAVEL || [];
        if (topicId === "school") return window.DATA_SCHOOL || [];
        if (topicId === "work") return window.DATA_WORK || [];
        if (topicId === "daily") return window.DATA_DAILY || [];
        if (topicId === "dates") return window.DATA_DATES || [];
        if (topicId === "hobbies") return window.DATA_HOBBIES || [];
        if (topicId === "routines") return window.DATA_ROUTINES || [];
        return [];
      }

      // ====== Auth gate ======
      function isAdmin(user){
        return !!(user && ADMIN_EMAILS.includes(user.email));
      }
      function openAdminUI(){
        adminUI.style.display = "block";
        noAccess.style.display = "none";
        btnLogin.style.display = "none";
        btnLogout.style.display = "inline-block";
        populateTopics(); renderWords();
      }
      function closeAdminUI(){
        adminUI.style.display = "none";
        noAccess.style.display = "block";
        btnLogin.style.display = "inline-block";
        btnLogout.style.display = "none";
      }

      // ====== UI refs ======
      const topicSel = $("#topicSel");
      const searchBox = $("#searchBox");
      const btnRefresh = $("#btn-refresh");
      const wordsTable = $("#wordsTable");
      const fileInput = $("#fileInput");
      const urlInput = $("#urlInput");
      const btnAttach = $("#btn-attach");
      const btnDelete = $("#btn-delete");
      const chosenWordEl = $("#chosenWord");
      const currentUrlEl = $("#currentUrl");
      const previewEl = $("#preview");

      let CURRENT_TOPIC = "food";
      let CURRENT_WORD = null;

      function populateTopics(){
        topicSel.innerHTML = "";
        BUILTIN_TOPICS.forEach(t=>{
          const opt = document.createElement("option");
          opt.value = t.id; opt.textContent = t.label;
          topicSel.appendChild(opt);
        });
        topicSel.value = CURRENT_TOPIC;
      }

      async function getGlobalUrl(topicId, wordId){
        const docId = `${topicId}__${wordId}`;
        const ref = fb.db.collection("globalImgOverrides").doc(docId);
        const doc = await ref.get();
        return doc.exists ? (doc.data()?.url || "") : "";
      }

      function renderWords(){
        const data = getDataset(CURRENT_TOPIC);
        const q = (searchBox.value||"").trim().toLowerCase();
        const list = q ? data.filter(w=>(w.word||"").toLowerCase().includes(q)) : data;

        const rows = list.map(w=>`
          <tr data-id="${w.id}">
            <td style="white-space:nowrap;padding:8px 10px">${w.word||""}</td>
            <td style="padding:8px 10px">${w.vi||""}</td>
            <td style="padding:8px 10px;width:240px">
              <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
                <button class="pick primary" data-id="${w.id}">Chá»n</button>
                <a class="link" target="_blank" href="${w.img||"#"}">${w.img?"áº¢nh gá»‘c":"(chÆ°a cÃ³ áº£nh gá»‘c)"}</a>
              </div>
            </td>
          </tr>`).join("");

        wordsTable.innerHTML = `
          <div style="overflow:auto;border:1px solid #f1d7e2;border-radius:12px;background:#fff;">
            <table style="width:100%;border-collapse:collapse">
              <thead><tr style="background:#fff4f8">
                <th style="text-align:left;padding:10px">Tá»«</th>
                <th style="text-align:left;padding:10px">NghÄ©a</th>
                <th style="text-align:left;padding:10px">HÃ nh Ä‘á»™ng</th>
              </tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
          <p style="margin:8px 2px;color:#666">Chá»n má»™t tá»«, rá»“i Upload/DÃ¡n URL Ä‘á»ƒ gáº¯n áº£nh GLOBAL.</p>
        `;
        wordsTable.querySelectorAll(".pick").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-id");
            CURRENT_WORD = data.find(w=>w.id===id) || null;
            chosenWordEl.textContent = CURRENT_WORD ? `${CURRENT_WORD.word} (${CURRENT_WORD.id})` : "chÆ°a";
            previewEl.style.display = "none";
            const gUrl = CURRENT_WORD ? await getGlobalUrl(CURRENT_TOPIC, CURRENT_WORD.id) : "";
            currentUrlEl.textContent = gUrl?"má»Ÿ áº£nh":"(chÆ°a cÃ³)";
            currentUrlEl.href = gUrl||"#";
          });
        });
      }

      async function uploadToImgur(file){
        if (!file) throw new Error("ChÆ°a chá»n file áº£nh.");
        const form = new FormData(); form.append("image", file);
        const res = await fetch("https://api.imgur.com/3/image", {
          method:"POST", headers:{Authorization:`Client-ID ${IMGUR_CLIENT_ID}`}, body:form
        });
        const json = await res.json();
        if (!json?.success) throw new Error("Upload Imgur tháº¥t báº¡i.");
        return json.data.link;
      }

      async function saveGlobalOverride(user,topicId,wordId,url){
        if (!isAdmin(user)) throw new Error("Báº¡n khÃ´ng cÃ³ quyá»n admin.");
        const docId = `${topicId}__${wordId}`;
        await fb.db.collection("globalImgOverrides").doc(docId).set({
          topicId,wordId,url,
          updatedBy:user.email,
          updatedAt:firebase.firestore.FieldValue.serverTimestamp(),
        },{merge:true});
      }
      async function deleteGlobalOverride(user,topicId,wordId){
        if (!isAdmin(user)) throw new Error("Báº¡n khÃ´ng cÃ³ quyá»n admin.");
        const docId = `${topicId}__${wordId}`;
        await fb.db.collection("globalImgOverrides").doc(docId).delete();
      }

      // ====== Events ======
      btnLogin.onclick = async ()=>{ try{ await fb.auth.signInWithPopup(fb.googleProvider);}catch(e){alert("ÄÄƒng nháº­p tháº¥t báº¡i: "+e.message);} };
      btnLogout.onclick = ()=> fb.auth.signOut();
      topicSel.onchange = ()=>{CURRENT_TOPIC=topicSel.value;CURRENT_WORD=null;chosenWordEl.textContent="chÆ°a";currentUrlEl.textContent="(chÆ°a cÃ³)";currentUrlEl.href="#";renderWords();};
      btnRefresh.onclick = renderWords;
      searchBox.oninput = renderWords;
      fileInput.onchange = ()=>{const f=fileInput.files?.[0]; if(!f){previewEl.style.display="none";return;} previewEl.src=URL.createObjectURL(f);previewEl.style.display="inline-block";};
      btnAttach.onclick = async ()=>{const user=fb.auth.currentUser; try{if(!CURRENT_WORD) throw new Error("HÃ£y chá»n má»™t tá»«."); btnAttach.disabled=true;btnAttach.textContent="Äang xá»­ lÃ½..."; let finalUrl=(urlInput.value||"").trim(); if(!finalUrl){const file=fileInput.files?.[0]; if(!file) throw new Error("Chá»n file hoáº·c dÃ¡n URL."); finalUrl=await uploadToImgur(file);} await saveGlobalOverride(user,CURRENT_TOPIC,CURRENT_WORD.id,finalUrl); currentUrlEl.textContent="má»Ÿ áº£nh";currentUrlEl.href=finalUrl; alert("ÄÃ£ lÆ°u áº£nh GLOBAL.");}catch(e){alert(e.message);}finally{btnAttach.disabled=false;btnAttach.textContent="LÆ°u áº£nh GLOBAL";}};
      btnDelete.onclick = async ()=>{const user=fb.auth.currentUser; try{if(!CURRENT_WORD) throw new Error("HÃ£y chá»n má»™t tá»«."); if(!confirm("XÃ³a áº£nh GLOBAL?")) return; await deleteGlobalOverride(user,CURRENT_TOPIC,CURRENT_WORD.id); currentUrlEl.textContent="(chÆ°a cÃ³)";currentUrlEl.href="#"; alert("ÄÃ£ xÃ³a áº£nh GLOBAL.");}catch(e){alert(e.message);}};

      // ====== Auth ======
      if(window.fb){ fb.auth.onAuthStateChanged((user)=>{ if(isAdmin(user)) openAdminUI(); else closeAdminUI(); }); }
    </script>
  </body>
</html>
